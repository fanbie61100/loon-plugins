#!name=酷安去广告
#!desc=屏蔽热词、开屏广告、推广广告、首页广告、评论广告、商品推广、酷品页推广，简化账号主页
#!icon=https://raw.githubusercontent.com/luestr/IconResource/main/App_icon/120px/CoolApk.png
#!tag=去广告,酷安


########################
# Rewrite（接口层拦截 / JSON 精简）
########################
[Rewrite]

# ────────────────
# 酷安 · 搜索页热词
# 作用：直接拦截“热搜关键词”接口，请求成功但返回空内容
# ────────────────
^https?:\/\/api\.coolapk\.com\/v6\/search\?.*type=hotSearch - reject-200

# 备用方案：字典拒绝（部分版本对 reject-200 不生效时使用）
^https:\/\/api\.coolapk\.com\/v6\/search\?.*type=hotSearch reject-dict


# ────────────────
# 酷安 · 动态详情页
# 作用：
# 1. 移除“热门评论 / 置顶评论”中的广告结构
# 2. 清空商品推广相关字段
# ────────────────
^https:\/\/api\.coolapk\.com\/v6\/feed\/detail\? response-body-json-jq '
.data.hotReplyRows |= if . then map(select(.id?)) else . end
| .data.topReplyRows |= if . then map(select(.id?)) else . end
| reduce ("detailSponsorCard", "include_goods", "include_goods_ids") as $key (.; .data[$key]=[])
'

# 重复一条同规则，用于增强匹配稳定性（不同参数顺序）
^https:\/\/api\.coolapk\.com\/v6\/feed\/detail\? response-body-json-jq '
.data.hotReplyRows |= if . then map(select(.id?)) else . end
| .data.topReplyRows |= if . then map(select(.id?)) else . end
| reduce ("detailSponsorCard", "include_goods", "include_goods_ids") as $key (.; .data[$key]=[])
'


# ────────────────
# 酷安 · 首页数据流
# 作用：移除首页中的赞助卡片 / 精选配件推广
# ────────────────
^https:\/\/api\.coolapk\.com\/v6\/main\/dataList response-body-json-jq '
.data |= (
  if (type=="array" and length>0)
  then map(select((.entityTemplate!="sponsorCard") and (.title!="精选配件")))
  else .
  end
)
'


# ────────────────
# 酷安 · 页面数据流（通用）
# 作用：
# - 去掉「酷安热搜」
# - 去掉图片放大卡
# - 去掉赞助卡
# ────────────────
^https:\/\/api\.coolapk\.com\/v6\/page\/dataList response-body-json-jq '
if (.data | length > 0)
then .data |= map(select(
  (.title? != "酷安热搜")
  and (.entityTemplate? != "imageScaleCard")
  and (.entityTemplate? != "sponsorCard")
))
else .
end
'

# 同上，重复规则，增强命中率
^https:\/\/api\.coolapk\.com\/v6\/page\/dataList response-body-json-jq '
if (.data | length > 0)
then .data |= map(select(
  (.title? != "酷安热搜")
  and (.entityTemplate? != "imageScaleCard")
  and (.entityTemplate? != "sponsorCard")
))
else .
end
'


# ────────────────
# 酷安 · 启动初始化接口
# 作用：
# - 移除指定 entityId（常见广告/运营位）
# - 在 entityId=20131 时，移除“酷品”入口
# ────────────────
^https:\/\/api\.coolapk\.com\/v6\/main\/init response-body-json-jq '
.data |= map(
  select(.entityId? | [944,945,6390] | index(.) | not)
  | if .entityId == 20131
    then .entities |= map(select(.title != "酷品"))
    else .
    end
)
'


########################
# Script（JS 脚本深度处理）
########################
[Script]

# ────────────────
# 酷安 · 开屏广告
# ────────────────
http-response ^https?:\/\/api.coolapk.com\/v6\/main\/init \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=开屏广告


# ────────────────
# 酷安 · 推广广告（信息流）
# ────────────────
http-response ^https?:\/\/api.coolapk.com\/v6\/dataList \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=推广广告


# ────────────────
# 酷安 · 首页广告
# ────────────────
http-response ^https?:\/\/api.coolapk.com\/v6\/main\/indexV8 \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=首页广告


# ────────────────
# 酷安 · 评论区广告
# ────────────────
http-response ^https?:\/\/api.coolapk.com\/v6\/feed\/replyList \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=评论广告


# ────────────────
# 酷安 · 动态内商品推广
# ────────────────
http-response ^https?:\/\/api.coolapk.com\/v6\/feed\/detail \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=商品推广


# ────────────────
# 酷安 · 酷品页推广
# （通过 title=%E9%85 命中酷品相关页面）
# ────────────────
http-response https://api.coolapk.com/v6/page/dataList\?.*title=%E9%85 \
script-path=https://github.com/ddgksf2013/Scripts/raw/master/coolapk.js, \
requires-body=true, timeout=60, tag=酷品页推广


# ────────────────
# 酷安 · 个人主页精简
# 作用：精简「我的」页面卡片结构
# ────────────────
http-response ^https:\/\/api\.coolapk\.com\/v6\/account\/loadConfig\?key=my_page_card_config \
requires-body=1, \
script-path=https://raw.githubusercontent.com/fanbie61100/loon-js/refs/heads/main/KuAn.js, \
tag=个人主页


########################
# MITM
########################
[MITM]
hostname = api.coolapk.com
